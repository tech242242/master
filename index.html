<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Control | Saqib Panel</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Poppins:wght@300;400;600&display=swap');
        body { font-family: 'Poppins', sans-serif; background: #020617; color: white; }
        .master-card { background: rgba(30, 41, 59, 0.5); border: 1px solid rgba(255,255,255,0.05); backdrop-filter: blur(10px); }
        .switch { position: relative; display: inline-block; width: 50px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #334155; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #3b82f6; }
        input:checked + .slider:before { transform: translateX(26px); }
    </style>
</head>
<body class="p-4 md:p-10">
    <div class="max-w-4xl mx-auto">
        <div class="flex justify-between items-center mb-10">
            <div>
                <h1 class="text-3xl font-bold font-['Orbitron'] tracking-widest text-blue-500 text-center">MASTER <span class="text-white">CONTROL</span></h1>
                <p class="text-gray-500 text-xs mt-1">Manage Saqib Panel Infrastructure</p>
            </div>
            <div class="bg-blue-600/10 p-4 rounded-2xl border border-blue-500/20 text-center">
                <p class="text-[10px] uppercase font-bold text-gray-400">Total Users</p>
                <p id="totalUsers" class="text-2xl font-bold">0</p>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Platform Toggles -->
            <div class="master-card p-8 rounded-[2rem]">
                <h2 class="text-lg font-bold mb-6 flex items-center gap-2"><i class="fas fa-toggle-on text-blue-500"></i> Platform Status</h2>
                <div id="statusList" class="space-y-6">
                    <p class="text-gray-500 text-sm italic">Loading status...</p>
                </div>
                <button onclick="updateSettings()" class="w-full mt-8 bg-blue-600 p-4 rounded-xl font-bold hover:bg-blue-500 transition">SAVE SETTINGS</button>
            </div>

            <!-- Recent Activity -->
            <div class="master-card p-8 rounded-[2rem]">
                <h2 class="text-lg font-bold mb-6 flex items-center gap-2"><i class="fas fa-users text-blue-500"></i> Registered Admins</h2>
                <div id="adminList" class="space-y-4 max-h-[400px] overflow-y-auto pr-2">
                    <p class="text-gray-500 text-sm italic">Fetching admins...</p>
                </div>
            </div>
        </div>
    </div>

<script>
const S_URL = 'https://fhvonxrsfdawustkuoll.supabase.co';
const S_KEY = 'sb_publishable_--n1PzlM1fQMid3BtOGHoQ_zu_YIAEV';
const supabaseClient = supabase.createClient(S_URL, S_KEY);

const PLATFORMS = ['tiktok', 'instagram', 'facebook', 'snapchat', 'google'];
let currentSettings = {};

async function init() {
    try {
        // Get total users with safe check
        const { count, error: countErr } = await supabaseClient.from('dashboard_users').select('*', { count: 'exact', head: true });
        document.getElementById('totalUsers').innerText = count || 0;

        // Get Admin List with null check
        const { data: users, error: userErr } = await supabaseClient.from('dashboard_users').select('username, created_at').order('created_at', {ascending: false});
        
        const adminListContainer = document.getElementById('adminList');
        if (users && users.length > 0) {
            adminListContainer.innerHTML = users.map(u => `
                <div class="flex justify-between items-center p-3 bg-white/5 rounded-xl border border-white/5">
                    <span class="font-bold text-sm">${u.username || 'Unknown'}</span>
                    <span class="text-[9px] text-gray-500">${u.created_at ? new Date(u.created_at).toLocaleDateString() : 'N/A'}</span>
                </div>
            `).join('');
        } else {
            adminListContainer.innerHTML = '<p class="text-gray-500 text-sm">No registered admins found.</p>';
        }

        // Get Settings with fallback
        const { data: settings, error: setErr } = await supabaseClient.from('panel_settings').select('*').eq('id', 'global_config').maybeSingle();
        
        currentSettings = settings || {
            tiktok_status: true,
            instagram_status: true,
            facebook_status: true,
            snapchat_status: true,
            google_status: true
        };
        
        document.getElementById('statusList').innerHTML = PLATFORMS.map(p => `
            <div class="flex justify-between items-center">
                <span class="capitalize font-medium text-sm text-gray-300"><i class="fab fa-${p} mr-3 w-5 text-center"></i> ${p} Portal</span>
                <label class="switch">
                    <input type="checkbox" id="check-${p}" ${currentSettings[p+'_status'] ? 'checked' : ''}>
                    <span class="slider"></span>
                </label>
            </div>
        `).join('');

    } catch (err) {
        console.error("Initialization Error:", err);
        document.getElementById('adminList').innerHTML = '<p class="text-red-500 text-xs">Error loading data. Check Supabase connection.</p>';
    }
}

async function updateSettings() {
    const newSettings = {};
    PLATFORMS.forEach(p => {
        newSettings[p+'_status'] = document.getElementById('check-'+p).checked;
    });

    const { error } = await supabaseClient.from('panel_settings').upsert({
        id: 'global_config',
        ...newSettings
    });

    if(!error) {
        alert("Global Settings Updated!");
    } else {
        console.error(error);
        alert("Update failed: " + error.message);
    }
}

init();
</script>
</body>
</html>
